################################################################################
# Docker Compose - Sistema de Análise de Filmes
# Versão: 1.0
# 
# Este arquivo define a infraestrutura containerizada para o projeto:
# - Banco de dados MySQL
# - Serviço de inicialização e ETL
################################################################################

version: '3.8'

services:
  # ============================================================================
  # Serviço: Banco de Dados MySQL
  # ============================================================================
  db:
    image: mysql:8.0
    container_name: movies_mysql_db
    restart: always
    
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: movies_db
      MYSQL_USER: app_user
      MYSQL_PASSWORD: app_password
      TZ: America/Sao_Paulo
    
    ports:
      - "3306:3306"
    
    volumes:
      # Persistência dos dados do MySQL
      - mysql_data:/var/lib/mysql
      
      # Scripts de inicialização do banco
      - ../Data Layer/silver/ddl_silver.sql:/docker-entrypoint-initdb.d/01-ddl_silver.sql:ro
    
    networks:
      - movies_network
    
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    command: 
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci

  # ============================================================================
  # Serviço: ETL e Inicialização
  # ============================================================================
  etl:
    build:
      context: ..
      dockerfile: Docker/Dockerfile.etl
    
    container_name: movies_etl_service
    
    depends_on:
      db:
        condition: service_healthy
    
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: movies_db
      DB_USER: app_user
      DB_PASSWORD: app_password
      PYTHONUNBUFFERED: 1
    
    volumes:
      # Monta os dados brutos
      - ../Data Layer/raw/dados_brutos:/app/data/raw/dados_brutos:ro
      
      # Monta o script ETL
      - ../Data Layer/silver/job_etl.py:/app/job_etl.py:ro
    
    networks:
      - movies_network
    
    # O container executa o ETL e depois encerra
    restart: "no"

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  mysql_data:
    driver: local
    name: movies_mysql_data

# ==============================================================================
# Networks
# ==============================================================================
networks:
  movies_network:
    driver: bridge
    name: movies_network